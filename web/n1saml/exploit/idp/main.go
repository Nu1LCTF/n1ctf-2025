package main

import (
	"crypto/rsa"
	"crypto/tls"
	"crypto/x509"
	"io"
	"net/http"
	"net/url"

	"github.com/crewjam/saml/logger"
	"github.com/crewjam/saml/samlsp"
	"golang.org/x/crypto/bcrypt"

	"github.com/crewjam/saml/samlidp"
)

func main() {
	idpURL, _ := url.Parse("http://IP:9001")
	keyPair, _ := tls.LoadX509KeyPair("idp.crt", "idp.key")
	keyPair.Leaf, _ = x509.ParseCertificate(keyPair.Certificate[0])

	store := &samlidp.MemoryStore{}

	hashedPassword, _ := bcrypt.GenerateFromPassword([]byte("123456"), bcrypt.DefaultCost)
	store.Put("/users/admin", samlidp.User{
		Name:           "Administrator",
		HashedPassword: hashedPassword,
		Groups:         []string{"Administrators", "Users"},
		Email:          "admin@nu1l.com",
	})

	resp, _ := http.Get("http://IP:9000/saml/metadata")
	b, _ := io.ReadAll(resp.Body)
	spMetadata, _ := samlsp.ParseMetadata(b)
	service := samlidp.Service{
		Metadata: *spMetadata,
	}
	store.Put("/services/sp", &service)

	idp, _ := samlidp.New(samlidp.Options{
		URL:         *idpURL,
		Key:         keyPair.PrivateKey.(*rsa.PrivateKey),
		Certificate: keyPair.Leaf,
		Store:       store,
		Logger:      logger.DefaultLogger,
	})

	http.ListenAndServe(":9001", idp)
}
